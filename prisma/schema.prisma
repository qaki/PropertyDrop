// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// Necessary for Next auth
model Account {
    id                       String  @id @default(cuid())
    userId                   String  @map("user_id")
    type                     String
    provider                 String
    providerAccountId        String  @map("provider_account_id")
    refresh_token            String? // @db.Text
    access_token             String? // @db.Text
    expires_at               Int?
    token_type               String?
    scope                    String?
    id_token                 String? // @db.Text
    session_state            String?
    user                     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
    refresh_token_expires_in Int?

    @@unique([provider, providerAccountId])
    @@map("accounts")
}

model Session {
    id           String   @id @default(cuid())
    sessionToken String   @unique @map("session_token")
    userId       String   @map("user_id")
    expires      DateTime
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@map("sessions")
}

model User {
    id                     String    @id @default(cuid())
    name                   String?
    email                  String?   @unique
    emailVerified          DateTime? @map("email_verified")
    emailVerificationToken String?   @unique @map("email_verification_token")
    image                  String?
    passwordHash           String?   @map("password_hash")

    // White-labeling / Branding (P3.1)
    companyName            String?   @map("company_name")
    companyLogo            String?   @map("company_logo")

    // Stripe Connect for receiving payments
    stripeAccountId        String?   @unique @map("stripe_account_id")
    stripeAccountStatus    String?   @default("pending") @map("stripe_account_status") // pending, complete, restricted

    // Trial Period (14 days free)
    trialStartDate         DateTime? @map("trial_start_date")
    trialEndDate           DateTime? @map("trial_end_date")

    // Whop Subscription (Photographer pays PropertyDrop)
    whopMembershipId       String?   @unique @map("whop_membership_id")
    subscriptionStatus     String?   @default("trial") @map("subscription_status") // trial, active, inactive, cancelled, expired
    subscriptionExpiresAt  DateTime? @map("subscription_expires_at")

    accounts      Account[]
    sessions      Session[]
    jobs          Job[]

    @@map("users")
}

model VerificationToken {
    identifier String
    token      String   @unique
    expires    DateTime

    @@unique([identifier, token])
    @@map("verification_tokens")
}

model Job {
  id               String   @id @default(cuid())
  name             String
  agentEmail       String   @map("agent_email")
  jobAmount        Int      @map("job_amount") // stored in cents
  isPaid           Boolean  @default(false) @map("is_paid")
  clientAccessHash String   @unique @default(uuid()) @map("client_access_hash")
  archivedDate     DateTime? @map("archived_date")
  
  // Property Description (P3.2)
  description      String?  @db.Text // Property listing description
  
  // Delivery Options (P2.3 & P2.4)
  deliverySize     String   @default("mls") @map("delivery_size") // mls (1024px), web (1920px), both
  includeOriginals Boolean  @default(false) @map("include_originals") // Include print-quality originals
  
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  photographer     User     @relation(fields: [photographerId], references: [id], onDelete: Cascade)
  photographerId   String   @map("photographer_id")

  status           String   @default("uploading") // uploading, processing, ready
  assets           Asset[]

  @@map("jobs")
  @@index([clientAccessHash])
  @@index([photographerId])
}

model Asset {
    id        String   @id @default(cuid())
    jobId     String   @map("job_id")
    job       Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
    
    originalKey      String  @map("original_key")
    mlsKey           String? @map("mls_key")
    originalFilename String  @default("unknown.jpg") @map("original_filename")
    
    resizeType       String  @default("mls") @map("resize_type") // mls, full, web, custom
    isProcessed      Boolean @default(true) @map("is_processed") // Default true for existing assets
    
    // Photo ordering (P2.1 - drag-and-drop reordering)
    order            Int     @default(0) // Display order set by photographer
    
    width        Int?
    height       Int?
    size         Int?
    mimeType     String? @map("mime_type")
    
    createdAt DateTime @default(now()) @map("created_at")
    
    @@map("assets")
    @@index([jobId])
    @@index([jobId, order]) // Compound index for efficient ordered queries
}
